rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated (works with both Google and Email auth)
    function isAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             (request.auth.token.admin == true || 
              request.auth.token.email in ['oussamaanis2005@gmail.com']);
    }

    // Check if user is delivery personnel
    function isDelivery() {
      return isAuthenticated() && 
             (request.auth.token.delivery == true ||
              request.auth.token.email in ['delivery@creperie-kinder.com']);
    }

    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Validate order data structure
    function isValidOrder() {
      let data = request.resource.data;
      return data.keys().hasAll(['customerName', 'customerPhone', 'items', 'total', 'status', 'createdAt']) &&
             data.customerName is string &&
             data.customerPhone is string &&
             data.items is list &&
             data.items.size() > 0 &&
             data.total is number &&
             data.total > 0 &&
             data.status in ['pending', 'in-progress', 'delivered'] &&
             data.createdAt is timestamp;
    }

    // Validate menu item data structure
    function isValidMenuItem() {
      let data = request.resource.data;
      return data.keys().hasAll(['name', 'desc', 'price', 'category', 'img']) &&
             data.name is string &&
             data.desc is string &&
             data.price is number &&
             data.price > 0 &&
             data.category is string &&
             data.img is string;
    }

    // ============================================
    // MENU COLLECTION RULES
    // ============================================
    match /menu/{menuId} {
      allow read: if true;
      allow create: if isAdmin() && isValidMenuItem();
      allow update: if isAdmin() && isValidMenuItem();
      allow delete: if isAdmin();
    }

    // ============================================
    // ORDERS COLLECTION RULES
    // ============================================
    match /orders/{orderId} {
      allow read: if isAdmin() || 
                     isDelivery() ||
                     (isAuthenticated() && resource.data.createdBy == request.auth.uid) ||
                     (isAuthenticated() && resource.data.customerEmail == request.auth.token.email);

      allow create: if (isAuthenticated() || request.auth == null) && 
                       isValidOrder() &&
                       request.resource.data.status == 'pending';

      allow update: if isAdmin() ||
                       (isDelivery() && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'acceptedForDelivery', 'acceptedBy', 'deliveredAt']) &&
                        request.resource.data.status in ['pending', 'in-progress', 'delivered']);

      allow delete: if isAdmin();
    }

    // ============================================
    // CUSTOMERS COLLECTION RULES
    // ============================================
    match /customers/{customerId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ============================================
    // USER PROFILES COLLECTION
    // ============================================
    match /users/{userId} {
      allow read: if isAdmin() || isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAdmin() || isOwner(userId);
      allow delete: if isAdmin() || isOwner(userId);
    }

    // ============================================
    // DELIVERY PERSONNEL COLLECTION
    // ============================================
    match /delivery_personnel/{deliveryId} {
      allow read: if isAdmin() || isOwner(deliveryId) || isDelivery();
      allow write: if isAdmin();
    }

    // ============================================
    // CATEGORIES COLLECTION
    // ============================================
    match /categories/{categoryId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================
    // ANALYTICS COLLECTION
    // ============================================
    match /analytics/{document=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ============================================
    // FEEDBACK COLLECTION
    // ============================================
    match /feedback/{feedbackId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['message', 'createdAt', 'userId']) &&
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // IMAGE STORAGE NOTE
    // ============================================
    // Images are stored on ImgBB cloud service (https://imgbb.com)
    // Firestore only stores the image URLs as strings in the 'img' field
    // No Firebase Storage rules needed - ImgBB handles all image hosting
  }
}
