
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // IMAGE STORAGE NOTE
    // ============================================
    // Images are stored on ImgBB cloud service (https://imgbb.com)
    // Firestore only stores the image URLs as strings in the 'img' field
    // No Firebase Storage rules needed - ImgBB handles all image hosting
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email in ['oussamaanis2005@gmail.com'];
    }

    function isValidOrder() {
      let data = request.resource.data;
      return data.keys().hasAll(['customerName', 'customerPhone', 'items', 'total', 'status', 'createdAt']) &&
             data.customerName is string &&
             data.customerPhone is string &&
             data.items is list &&
             data.items.size() > 0 &&
             data.total is number &&
             data.total > 0 &&
             data.status in ['pending', 'in-progress', 'delivered'] &&
             data.createdAt is timestamp;
    }

    function isValidMenuItem() {
      let data = request.resource.data;
      return data.keys().hasAll(['name', 'desc', 'price', 'category']) &&
             data.name is string &&
             data.desc is string &&
             data.price is number &&
             data.price > 0 &&
             data.category is string &&
             // Image URL is optional but must be a string if present (from ImgBB)
             (!data.keys().hasAny(['img']) || data.img is string);
    }

    function isValidCategory() {
      let data = request.resource.data;
      return data.keys().hasAll(['name']) &&
             data.name is string;
    }

    // ============================================
    // MENU COLLECTION
    // ============================================
    match /menu/{menuId} {
      allow read: if true;
      allow create: if isAdmin() && isValidMenuItem();
      allow update: if isAdmin() && isValidMenuItem();
      allow delete: if isAdmin();
    }

    // ============================================
    // CATEGORIES COLLECTION
    // ============================================
    match /categories/{categoryId} {
      allow read: if true;
      allow create: if isAdmin() && isValidCategory();
      allow update: if isAdmin() && isValidCategory();
      allow delete: if isAdmin();
    }

    // ============================================
    // ORDERS COLLECTION
    // ============================================
    match /orders/{orderId} {
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.createdBy == request.auth.uid);
      allow create: if isValidOrder() && request.resource.data.status == 'pending';
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================
    // CUSTOMERS COLLECTION
    // ============================================
    match /customers/{customerId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ============================================
    // ANALYTICS COLLECTION
    // ============================================
    match /analytics/{document=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
  }
}
